import { logger } from '@lwrjs/diagnostics';
import { ViewSpan, getTracer } from '@lwrjs/instrumentation';
import { addHeadMarkup } from '../utils.js';
import { getRenderer } from '../renderer.js';
const NAME = 'preload-data-transformer';
/**
 * This view transformer preloads data on the server for CSRed routes.
 * If the route has:
 *  - a "rootComponent" and
 *  - the "ssr" bootstrap flag is OFF
 * then it will:
 *  - run getServerData() from the rootComponent and
 *  - serialize the output into globalThis.LWR.serverData
 * To consume the data on the client, access globalThis.LWR.serverData from a bootstrap service.
 */
export default function preloadDataViewTransformer(_options, { config, moduleBundler, resourceRegistry }) {
    const routes = [...config.routes, ...config.errorRoutes];
    return {
        name: NAME,
        async link(stringBuilder, viewContext, metadata) {
            const { rootComponent } = viewContext.view;
            if (!rootComponent ||
                !viewContext.view.bootstrap?.preloadData ||
                viewContext.view.bootstrap?.ssr) {
                return {}; // must be a CSRed rootComponent with preloadData ON
            }
            logger.debug({ label: NAME, message: `Preload data for root component "${rootComponent}"` });
            const { results = {}, errors } = await getTracer().trace({
                name: ViewSpan.PreloadData,
                attributes: { rootComponent },
            }, async () => {
                const route = routes.find((r) => r.id === viewContext.view.id);
                if (!route) {
                    throw new Error(`Unable to resolve configuration for view: ${viewContext.view.id}`);
                }
                return await getRenderer(config, moduleBundler, resourceRegistry).render({ [rootComponent]: { specifier: rootComponent, props: {} } }, route, viewContext.runtimeEnvironment, viewContext.runtimeParams);
            });
            // If we find errors just log as warnings since these are SSR errors for a CSR page
            if (errors) {
                for (const err of Object.entries(errors)) {
                    logger.warn({
                        label: 'preloadDataViewTransformer',
                        message: `Unexpected error during preload data: ${err[0]}`,
                    }, err[1]);
                }
                // Returns no data since there was an error loading modules
                return {};
            }
            // Log and process the data response
            const { props, markup, cache: { ttl } = { ttl: undefined }, status } = results[rootComponent];
            logger.verbose({ label: NAME, message: 'response', additionalInfo: props });
            markup && addHeadMarkup([results[rootComponent]], stringBuilder); // add links to the <head> tag
            metadata.serverData = metadata.serverData || {}; // create serverData if necessary
            Object.assign(metadata.serverData, props); // add the preloaded data to serverData for serialization
            return { cache: { ttl }, status };
        },
    };
}
//# sourceMappingURL=index.js.map
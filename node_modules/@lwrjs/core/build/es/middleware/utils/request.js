import qs from 'qs';
import { pathToRegexp } from 'path-to-regexp';
import { explodeSpecifier } from '@lwrjs/shared-utils';
function decodeParam(val) {
    if (typeof val !== 'string' || val.length === 0) {
        return val;
    }
    return decodeURIComponent(val);
}
// Adapted from https://github.com/expressjs/express/blob/master/lib/router/layer.js
export function getRequestProperties(pattern, req) {
    const { url = '/' } = req;
    const [pathname, search] = url.split('?');
    const keys = [];
    const regexp = pathToRegexp(pattern, keys);
    const matched = regexp.exec(pathname);
    const params = {};
    if (matched) {
        const query = qs.parse(search);
        for (let i = 1; i < matched.length; i++) {
            const key = keys[i - 1];
            const prop = key.name;
            const val = decodeParam(matched[i]);
            if (val !== undefined || !Object.hasOwnProperty.call(params, prop)) {
                params[prop] = val;
            }
        }
        return {
            url,
            params,
            query,
        };
    }
    return;
}
export async function getRequestImporter(req, moduleRegistry, runtimeParams) {
    const importerSpecifier = req.query.importer;
    const importerModuleId = explodeSpecifier(importerSpecifier);
    const { entry } = await moduleRegistry.getModuleEntry(importerModuleId, runtimeParams);
    return entry;
}
//# sourceMappingURL=request.js.map